name: CI/CD

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Build Backend Docker Image on Frontend VM
        run: |
          echo "Conectando à VM do frontend..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p 22 redes@127.0.0.1 << EOF
            
            echo "Construindo a imagem Docker do backend..."
    
            echo "Gerando build TAR do backend no frontend..."
            cd /home/redes/redes/backend
            tar -czf backend.tar.gz .

           
            
            
            echo "" | tr -d '\r' > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            echo "Criando diretório no backend..."
          

            echo "Transferindo imagem para o backend..."
            scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -P 22 backend_image.tar.gz redes@192.168.56.102:/home/redes/backend/
            
            echo "Carregando e subindo o backend..."
            ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p 22 redes@192.168.56.102 << 'BACKEND_EOF'
              cd /home/redes/backend
              gunzip -c backend_image.tar.gz | docker load

              echo "Executando o container..."
              docker-compose down || true
              docker-compose up -d
            BACKEND_EOF
          EOF
