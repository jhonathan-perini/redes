name: CI/CD

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Check out code
        uses: actions/checkout@v3
      
      - name: Deploy usando PowerShell
        run: |
          $sshCommand = "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p 2222"
          $scpCommand = "scp -r -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -P 2222"
      
  
          # Remover o diretório na VM antes de copiar
          Invoke-Expression "$sshCommand ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} 'rm -rf /home/john/redes && mkdir -p /home/john/redes'"

          # Transferir arquivos usando SCP
          Invoke-Expression "$scpCommand  ./ ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:/home/john/redes"
      
      - name: Build Backend Docker Image on Frontend VM
        run: |
              # Comandos a serem executados na VM do Frontend
              $commands = @"
              echo "Construindo a imagem Docker do backend..."
              cd /home/john/redes/frontend  # Caminho corrigido 
              docker-compose down || true
              docker-compose up -d --build 
        
              echo "Construindo a imagem Docker do backend..."
              cd /home/john/redes/backend 
              docker build -t backend_image:latest .
              echo "Salvando a imagem como .tar..."
              docker save backend_image:latest | gzip > backend_image.tar.gz
        
              echo "Criando diretório no backend..."
              mkdir -p /home/redes/backend
        
              echo "Transferindo imagem para o backend..."
              scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -P 22 backend_image.tar.gz redes@192.168.56.102:/home/redes/backend/
        
              echo "Carregando e subindo o backend..."
              cd /home/redes/backend
              gunzip -c backend_image.tar.gz | docker load
              echo "Executando o container..."
              docker-compose down || true
              docker-compose up -d
              "@
        
              # Executando os comandos na VM do Frontend
              $sshCommand = "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p 2222 redes@127.0.0.1"
              Invoke-Expression "$sshCommand '$commands'"